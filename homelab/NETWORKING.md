# homelab/NETWORKING.md — Container DNS and Service Discovery

## Problem: Consul DNS not available inside podman-compose containers

Consul registers internal services under `.service.consul` names (e.g.
`litellm.service.consul`, `nomad.service.consul`).  OpenClaw's `openclaw.json`
and `.env` reference these names as service endpoints.

`docker-compose.yml` specifies the Consul DNS servers via the `dns:` directive:

```yaml
dns:
  - 192.168.252.7
  - 192.168.252.8
```

**However**, podman-compose 1.0.3 silently drops the `dns:` directive.  The
container's `/etc/resolv.conf` is generated by Podman's internal CNI stack and
only contains `10.89.2.1` (Podman's built-in DNS forwarder) plus the public
resolvers `8.8.8.8` / `8.8.4.4`.  Neither of these forward `.consul` queries,
so `.service.consul` names fail to resolve inside the container while they work
fine on the host.

This manifests as `curl: (6) Could not resolve host: litellm.service.consul`
inside the container, and "Connection error." responses from OpenClaw agents.

---

## Current workaround: `extra_hosts` in `docker-compose.podman.yml`

`docker-compose.podman.yml` adds static `/etc/hosts` entries (podman `--add-host`)
for each Consul service the gateway needs to reach:

```yaml
extra_hosts:
  - "litellm.service.consul:192.168.252.6"
```

**How to update if a service moves:**

1. Find the new IP: `dig +short litellm.service.consul @192.168.252.7`
2. Update the `extra_hosts` entry in `docker-compose.podman.yml`
3. Restart: `./homelab/ctl.sh down && ./homelab/ctl.sh up`

Add a line for any other `.service.consul` name the gateway needs to reach
(e.g. if Nomad API calls are added).

---

## Long-term solution: use Tailscale domain names

Tailscale DNS names (e.g. `litellm.shamsway.net`) resolve correctly inside the
container without any workaround — they go through standard public/Tailscale
DNS, not Consul.

**Verified:** `https://litellm.shamsway.net/health/liveliness` returns
`"I'm alive!"` from inside the container.

**Migration path:**

1. In `.env`, change `LITELLM_BASE_URL` to the Tailscale domain:
   ```
   LITELLM_BASE_URL=https://litellm.shamsway.net
   ```
2. In `openclaw.json`, change the litellm `baseUrl` to use the env var:
   ```json
   "litellm": {
     "baseUrl": "${LITELLM_BASE_URL}",
     ...
   }
   ```
3. Remove the `extra_hosts` workaround from `docker-compose.podman.yml` once
   all `.service.consul` references are replaced.

This approach is more portable (works on any node, any network) and eliminates
the static IP dependency.

---

## Other affected services

Any other Consul-registered service referenced by hostname inside the container
will need the same treatment (either an `extra_hosts` entry or a switch to a
Tailscale/stable domain).  Current known dependencies:

| Service | Consul name | Current approach |
|---------|-------------|------------------|
| LiteLLM proxy | `litellm.service.consul:4000` | `extra_hosts` workaround |
| Nomad API | `nomad.service.consul:4646` | not called from container (env var set but unused at runtime) |
| Consul API | `127.0.0.1:8500` | direct IP, not affected |
